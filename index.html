<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 住转住专 - 拽 </title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            margin-top: 5vh; 
            background-color: #1a1a2e; 
            color: #e94560;
        }
        h1 { color: #4ecca3; text-shadow: 1px 1px 2px #0f3460; margin-bottom: 5px; }
        p.subtitle { color: #bdc3c7; margin-top: 0; margin-bottom: 30px;}
        #note { 
            font-size: 80px; 
            font-weight: bold; 
            color: #f1c40f; 
            margin: 20px 0; 
            min-height: 100px;
        }
        .controls {
            margin: 20px auto;
            padding: 20px;
            background-color: #16213e;
            border-radius: 10px;
            display: inline-block;
            max-width: 90%;
        }
        select, button { 
            font-size: 18px; 
            padding: 12px 24px; 
            margin: 10px;
            cursor: pointer; 
            border-radius: 8px;
            border: none;
            transition: all 0.2s;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #recordBtn { background-color: #e74c3c; color: white; font-weight: bold; }
        #recordBtn.recording { background-color: #c0392b; animation: pulse 1s infinite; }
        #playBtn { background-color: #2ecc71; color: white; font-weight: bold; display: none; }
        
        select { background-color: #0f3460; color: white; }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        #status { font-size: 20px; color: #ecf0f1; margin-top: 10px; min-height: 30px;}
    </style>
</head>
<body>

    <h1>驻 驻 </h1>
    <p class="subtitle"> , 砖  转 专 爪专 砖转</p>
    
    <div class="controls">
        <label for="waveform">专   驻拽:</label><br>
        <select id="waveform">
            <option value="sine">住住 专 (/砖专拽转)</option>
            <option value="square">专注 (拽专 / 专专)</option>
            <option value="sawtooth">砖 住专 (专 / 爪爪专)</option>
            <option value="triangle">砖砖 (驻注 专)</option>
        </select>
        <br>
        <button id="recordBtn"> 转 拽 </button>
        <button id="playBtn">讹  转  转拽转</button>
    </div>

    <div id="note">-</div>
    <div id="status"> 拽...</div>

    <script>
        let audioContext;
        let analyser;
        let microphone;
        let oscillator;
        let gainNode;
        
        // 专 砖: 注专 砖砖专 转 转专  专注 转
        let memoryFrames = []; 
        let recordingInterval;
        let playbackInterval;

        const noteStrings = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const recordBtn = document.getElementById('recordBtn');
        const playBtn = document.getElementById('playBtn');
        const statusEl = document.getElementById('status');
        const noteEl = document.getElementById('note');

        // 驻拽爪转  转转
        function autoCorrelate(buf, sampleRate) {
            let SIZE = buf.length;
            let rms = 0;
            for (let i = 0; i < SIZE; i++) rms += buf[i] * buf[i];
            rms = Math.sqrt(rms / SIZE);
            if (rms < 0.02) return -1;

            let r1 = 0, r2 = SIZE - 1, thres = 0.2;
            for (let i = 0; i < SIZE / 2; i++) if (Math.abs(buf[i]) < thres) { r1 = i; break; }
            for (let i = 1; i < SIZE / 2; i++) if (Math.abs(buf[SIZE - i]) < thres) { r2 = SIZE - i; break; }

            buf = buf.slice(r1, r2);
            SIZE = buf.length;

            let c = new Array(SIZE).fill(0);
            for (let i = 0; i < SIZE; i++)
                for (let j = 0; j < SIZE - i; j++)
                    c[i] = c[i] + buf[j] * buf[j + i];

            let d = 0; while (c[d] > c[d + 1]) d++;
            let maxval = -1, maxpos = -1;
            for (let i = d; i < SIZE; i++) if (c[i] > maxval) { maxval = c[i]; maxpos = i; }
            let T0 = maxpos;
            return sampleRate / T0;
        }

        // --- 砖 1: 拽 专 ---
        recordBtn.addEventListener('click', async () => {
            if (recordBtn.classList.contains('recording')) {
                // 注爪专转 拽
                clearInterval(recordingInterval);
                recordBtn.classList.remove('recording');
                recordBtn.innerText = " 拽 砖";
                playBtn.style.display = 'inline-block';
                statusEl.innerText = "拽 砖专 专!";
                noteEl.innerText = "-";
                return;
            }

            // 转转 拽
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') await audioContext.resume();

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                microphone.connect(analyser);

                memoryFrames = []; // 驻住 专
                recordBtn.classList.add('recording');
                recordBtn.innerText = "癸 住 拽";
                playBtn.style.display = 'none';
                statusEl.innerText = "拽...  注砖!";

                //  50 驻转 砖,  拽 转 转专 砖专 专
                recordingInterval = setInterval(() => {
                    let buffer = new Float32Array(analyser.fftSize);
                    analyser.getFloatTimeDomainData(buffer);
                    let pitch = autoCorrelate(buffer, audioContext.sampleRate);

                    if (pitch !== -1 && pitch > 50 && pitch < 2000) {
                        // 转拽 转 祝 砖专 转专 砖
                        let noteNum = Math.round(12 * (Math.log(pitch / 440) / Math.log(2))) + 69;
                        let perfectPitch = 440 * Math.pow(2, (noteNum - 69) / 12);
                        memoryFrames.push(perfectPitch);
                        noteEl.innerText = noteStrings[noteNum % 12];
                    } else {
                        // 砖拽 (  专专)
                        memoryFrames.push(0); 
                        noteEl.innerText = "-";
                    }
                }, 50);

            } catch (err) {
                alert('砖 砖专 砖 拽专驻  拽.');
            }
        });

        // --- 砖 2:  专 ---
        playBtn.addEventListener('click', () => {
            if (memoryFrames.length === 0) return;

            recordBtn.disabled = true;
            playBtn.disabled = true;
            statusEl.innerText = " 转  转拽转...";

            // 拽转 住转住专
            oscillator = audioContext.createOscillator();
            gainNode = audioContext.createGain();
            oscillator.type = document.getElementById('waveform').value;
            
            gainNode.gain.value = 0; // 转 砖拽
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start();

            let currentFrame = 0;

            // 拽专 专 转 拽爪 砖 拽 ( 50 驻转 砖)
            playbackInterval = setInterval(() => {
                if (currentFrame >= memoryFrames.length) {
                    // 住 
                    clearInterval(playbackInterval);
                    gainNode.gain.setTargetAtTime(0, audioContext.currentTime, 0.05);
                    setTimeout(() => oscillator.stop(), 100);
                    
                    recordBtn.disabled = false;
                    playBtn.disabled = false;
                    statusEl.innerText = "住 . 驻砖专 拽 砖   砖.";
                    noteEl.innerText = "-";
                    return;
                }

                let freq = memoryFrames[currentFrame];
                if (freq > 0) {
                    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                    gainNode.gain.setTargetAtTime(0.5, audioContext.currentTime, 0.02); // 
                    
                    // 转爪
                    let noteNum = Math.round(12 * (Math.log(freq / 440) / Math.log(2))) + 69;
                    noteEl.innerText = noteStrings[noteNum % 12];
                } else {
                    gainNode.gain.setTargetAtTime(0, audioContext.currentTime, 0.02); // 砖转拽
                    noteEl.innerText = "-";
                }

                currentFrame++;
            }, 50);
        });

    </script>
</body>
</html>
