<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>טיונר מקצועי</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            margin-top: 10vh; 
            background-color: #2c3e50; 
            color: #ecf0f1;
        }
        #note { 
            font-size: 140px; 
            font-weight: bold; 
            color: #f1c40f; 
            margin: 10px 0; 
            min-height: 160px;
        }
        #frequency { 
            font-size: 32px; 
            font-weight: bold;
            color: #bdc3c7; 
            margin-bottom: 10px;
        }
        #cents {
            font-size: 24px;
            font-weight: bold;
            transition: color 0.2s;
        }
        button { 
            font-size: 20px; 
            padding: 15px 30px; 
            cursor: pointer; 
            background-color: #e74c3c; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <h1>טיונר מדויק לכלים</h1>
    <button id="startButton">התחל טיונר</button>
    <div id="note">-</div>
    <div id="frequency">0.00 Hz</div>
    <div id="cents">ממתין לצליל...</div>

    <script>
        let audioContext;
        let analyser;
        let microphone;
        const noteStrings = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

        document.getElementById('startButton').addEventListener('click', async () => {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 4096; // הוגדל לדיוק גבוה יותר
                microphone.connect(analyser);
                
                document.getElementById('startButton').style.display = 'none';
                detectPitch();
            } catch (err) {
                alert('יש לאשר גישה למיקרופון בדפדפן.');
            }
        });

        function autoCorrelate(buf, sampleRate) {
            let SIZE = buf.length;
            let rms = 0;
            for (let i = 0; i < SIZE; i++) rms += buf[i] * buf[i];
            rms = Math.sqrt(rms / SIZE);
            if (rms < 0.01) return -1; // שקט

            let r1 = 0, r2 = SIZE - 1, thres = 0.2;
            for (let i = 0; i < SIZE / 2; i++) if (Math.abs(buf[i]) < thres) { r1 = i; break; }
            for (let i = 1; i < SIZE / 2; i++) if (Math.abs(buf[SIZE - i]) < thres) { r2 = SIZE - i; break; }

            buf = buf.slice(r1, r2);
            SIZE = buf.length;

            let c = new Array(SIZE).fill(0);
            for (let i = 0; i < SIZE; i++)
                for (let j = 0; j < SIZE - i; j++)
                    c[i] = c[i] + buf[j] * buf[j + i];

            let d = 0; while (c[d] > c[d + 1]) d++;
            let maxval = -1, maxpos = -1;
            for (let i = d; i < SIZE; i++) {
                if (c[i] > maxval) {
                    maxval = c[i];
                    maxpos = i;
                }
            }
            let T0 = maxpos;
            return sampleRate / T0;
        }

        function detectPitch() {
            let buffer = new Float32Array(analyser.fftSize);
            analyser.getFloatTimeDomainData(buffer);
            let pitch = autoCorrelate(buffer, audioContext.sampleRate);

            if (pitch !== -1) {
                // מציאת התו הקרוב ביותר
                let noteFloat = 12 * (Math.log(pitch / 440) / Math.log(2));
                let note = Math.round(noteFloat) + 69;
                
                // חישוב התדר המדויק של אותו תו
                let targetPitch = 440 * Math.pow(2, (note - 69) / 12);
                
                // חישוב הסטייה בסנטים
                let cents = Math.round(1200 * Math.log2(pitch / targetPitch));

                // עדכון המסך
                document.getElementById('note').innerText = noteStrings[note % 12];
                document.getElementById('frequency').innerText = pitch.toFixed(2) + " Hz";

                let centsEl = document.getElementById('cents');
                
                if (Math.abs(cents) <= 3) {
                    centsEl.innerText = "מכוון! (" + cents + " סנט)";
                    centsEl.style.color = "#2ecc71"; // ירוק
                } else if (cents > 3) {
                    centsEl.innerText = "גבוה מדי (" + cents + "+ סנט)";
                    centsEl.style.color = "#e74c3c"; // אדום
                } else {
                    centsEl.innerText = "נמוך מדי (" + cents + " סנט)";
                    centsEl.style.color = "#3498db"; // כחול
                }
            }

            requestAnimationFrame(detectPitch);
        }
    </script>
</body>
</html>
